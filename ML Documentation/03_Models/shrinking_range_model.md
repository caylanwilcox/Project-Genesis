# Shrinking Range Model - Technical Documentation

## Model Overview

| Property | Value |
|----------|-------|
| **Purpose** | Predict remaining high/low from current price |
| **Type** | Regression (Dual Model, Time-Aware) |
| **Output** | Remaining upside % and downside % |
| **Features** | 10 |

## Model Architecture

### Dual Model Design

```
┌─────────────────────────────────────────────────────────────┐
│                  SHRINKING RANGE PREDICTOR                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────┐  ┌───────────────────────────┐  │
│  │    UPSIDE MODEL       │  │    DOWNSIDE MODEL         │  │
│  │  GradientBoosting     │  │   GradientBoosting        │  │
│  │  Predicts: remaining  │  │   Predicts: remaining     │  │
│  │  upside from current  │  │   downside from current   │  │
│  └───────────────────────┘  └───────────────────────────┘  │
│                                                             │
│              ↓ time-decay adjustment ↓                      │
│                                                             │
│   Final Range: [current - downside%, current + upside%]     │
└─────────────────────────────────────────────────────────────┘
```

### Algorithm Configuration

```python
GradientBoostingRegressor(
    n_estimators=100,
    max_depth=4,
    learning_rate=0.1,
    random_state=42
)
```

## Target Variables

```python
# Remaining upside from current price to day high
remaining_upside = ((day_high - current_price) / current_price) * 100

# Remaining downside from current price to day low
remaining_downside = ((current_price - day_low) / current_price) * 100
```

## Training Data Generation

### Time Slice Simulation

Since full intraday data is limited, training samples are generated by simulating different time points:

```python
# 12 time slices per day (every 30 minutes)
time_slices = [0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6.0]

# For each day, create 12 samples simulating different times
# Total: ~400 days × 12 slices = ~4,800 samples per ticker
```

### Simulation Method

```python
# Simulate high/low achieved by time T
time_factor = sqrt(hours_elapsed / 6.5)

# High/low develop with sqrt(time) approximation
high_so_far_pct = day_high_pct * time_factor * random(0.7, 1.0)
low_so_far_pct = day_low_pct * time_factor * random(0.7, 1.0)

# Current price between high and low
price_position = random(0.3, 0.7)
current_pct = -low_so_far_pct + (high_so_far_pct + low_so_far_pct) * price_position
```

## Training Configuration

| Parameter | Value |
|-----------|-------|
| Days Simulated | ~400 |
| Time Slices per Day | 12 |
| Total Samples | ~3,636 per ticker |
| Feature Scaling | StandardScaler |
| Buffer Optimization | Not required (>90% baseline) |

## Model Files

```
ml/models/spy_shrinking_model.pkl
ml/models/qqq_shrinking_model.pkl
ml/models/iwm_shrinking_model.pkl
```

### File Structure
```python
{
    'up_model': GradientBoostingRegressor,
    'down_model': GradientBoostingRegressor,
    'scaler': StandardScaler,
    'feature_cols': [...],  # 10 features
    'buffer': float,
    'ticker': str,
    'trained_at': str,
    'version': 'shrinking_v1',
    'metrics': {
        'capture_rate': float,
        'up_mae': float,
        'down_mae': float,
        'samples': int
    }
}
```

## Performance Metrics

| Ticker | Capture Rate | Upside MAE | Downside MAE | Buffer |
|--------|-------------|-----------|-------------|--------|
| SPY | 91.9% | 0.041% | 0.045% | +0.00% |
| QQQ | 93.3% | 0.054% | 0.059% | +0.00% |
| IWM | 93.5% | 0.061% | 0.068% | +0.00% |

## How Shrinking Works

The model learns that as time progresses, the remaining range shrinks:

| Time | Time Remaining | Typical Range Shrink |
|------|---------------|---------------------|
| 9:30 AM | 100% | Full wide range |
| 11:00 AM | 77% | ~80% of wide |
| 1:00 PM | 46% | ~50% of wide |
| 3:00 PM | 15% | ~20% of wide |
| 3:30 PM | 8% | ~10% of wide |

## Code References

### Training Script
```
ml/train_shrinking_range_model.py:1-366
```

### Time Slice Dataset Builder
```
ml/train_shrinking_range_model.py:80-201
```

### Model Training
```
ml/train_shrinking_range_model.py:204-330
```

### Model Loading (Server)
```
ml/predict_server.py:116-128
```

### Prediction Function
```
ml/predict_server.py:758-832
```

---

Last Verified: December 8, 2025
