// Prisma Schema for ML Trading System
// This schema matches the existing Supabase database structure

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Market Data - Historical OHLCV data
model MarketData {
  id        String   @id @default(uuid()) @db.Uuid
  ticker    String   @db.VarChar(10)
  timeframe String   @db.VarChar(10)
  timestamp DateTime @db.Timestamptz(6)
  open      Decimal  @db.Decimal(12, 4)
  high      Decimal  @db.Decimal(12, 4)
  low       Decimal  @db.Decimal(12, 4)
  close     Decimal  @db.Decimal(12, 4)
  volume    Decimal  @db.Decimal(18, 2)
  source    String   @default("polygon") @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([ticker, timeframe, timestamp])
  @@index([ticker, timeframe, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("market_data")
}

// Features - Technical indicators calculated from market data
model Feature {
  id           String   @id @default(uuid()) @db.Uuid
  ticker       String   @db.VarChar(10)
  timeframe    String   @db.VarChar(10)
  timestamp    DateTime @db.Timestamptz(6)
  featureName  String   @map("feature_name") @db.VarChar(100)
  featureValue Decimal  @map("feature_value") @db.Decimal(12, 6)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([ticker, timeframe, timestamp, featureName])
  @@index([ticker, timeframe, timestamp(sort: Desc)])
  @@index([ticker, featureName, timestamp(sort: Desc)])
  @@map("features")
}

// Predictions - ML model predictions
model Prediction {
  id                 String   @id @default(uuid()) @db.Uuid
  ticker             String   @db.VarChar(10)
  timeframe          String   @db.VarChar(10)
  timestamp          DateTime @db.Timestamptz(6)
  modelName          String   @map("model_name") @db.VarChar(50)
  predictedDirection String?  @map("predicted_direction") @db.VarChar(10)
  predictedChange    Decimal? @map("predicted_change") @db.Decimal(8, 4)
  confidence         Decimal? @db.Decimal(5, 4)
  actualDirection    String?  @map("actual_direction") @db.VarChar(10)
  actualChange       Decimal? @map("actual_change") @db.Decimal(8, 4)
  accuracy           Decimal? @db.Decimal(5, 4)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([ticker, timeframe, timestamp, modelName])
  @@index([ticker, modelName, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("predictions")
}

// Models - Metadata about trained ML models
model Model {
  id               String    @id @default(uuid()) @db.Uuid
  modelName        String    @unique @map("model_name") @db.VarChar(50)
  modelType        String    @map("model_type") @db.VarChar(50)
  ticker           String    @db.VarChar(10)
  timeframe        String    @db.VarChar(10)
  trainingStarted  DateTime? @map("training_started") @db.Timestamptz(6)
  trainingFinished DateTime? @map("training_finished") @db.Timestamptz(6)
  status           String    @default("pending") @db.VarChar(20)
  accuracy         Decimal?  @db.Decimal(5, 4)
  parameters       Json?     @db.JsonB
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@index([ticker, timeframe])
  @@index([status])
  @@map("models")
}

// Trades - Trading bot execution history (for Week 11)
model Trade {
  id          String    @id @default(uuid()) @db.Uuid
  ticker      String    @db.VarChar(10)
  direction   String    @db.VarChar(10)
  entryPrice  Decimal   @map("entry_price") @db.Decimal(12, 4)
  exitPrice   Decimal?  @map("exit_price") @db.Decimal(12, 4)
  quantity    Decimal   @db.Decimal(12, 4)
  entryTime   DateTime  @map("entry_time") @db.Timestamptz(6)
  exitTime    DateTime? @map("exit_time") @db.Timestamptz(6)
  pnl         Decimal?  @db.Decimal(12, 4)
  status      String    @default("open") @db.VarChar(20)
  modelName   String?   @map("model_name") @db.VarChar(50)
  confidence  Decimal?  @db.Decimal(5, 4)
  stopLoss    Decimal?  @map("stop_loss") @db.Decimal(12, 4)
  takeProfit  Decimal?  @map("take_profit") @db.Decimal(12, 4)
  commission  Decimal?  @default(0) @db.Decimal(8, 4)
  notes       String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([ticker, entryTime(sort: Desc)])
  @@index([status])
  @@map("trades")
}

// Portfolio - Portfolio tracking and performance metrics (for Week 11)
model Portfolio {
  id              String   @id @default(uuid()) @db.Uuid
  timestamp       DateTime @db.Timestamptz(6)
  cashBalance     Decimal  @map("cash_balance") @db.Decimal(12, 2)
  equityValue     Decimal  @map("equity_value") @db.Decimal(12, 2)
  totalValue      Decimal  @map("total_value") @db.Decimal(12, 2)
  dailyPnl        Decimal? @map("daily_pnl") @db.Decimal(12, 2)
  totalPnl        Decimal? @map("total_pnl") @db.Decimal(12, 2)
  openPositions   Int?     @map("open_positions")
  totalTrades     Int?     @map("total_trades")
  winningTrades   Int?     @map("winning_trades")
  losingTrades    Int?     @map("losing_trades")
  winRate         Decimal? @map("win_rate") @db.Decimal(5, 4)
  sharpeRatio     Decimal? @map("sharpe_ratio") @db.Decimal(8, 4)
  maxDrawdown     Decimal? @map("max_drawdown") @db.Decimal(8, 4)
  maxDrawdownPct  Decimal? @map("max_drawdown_pct") @db.Decimal(5, 4)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([timestamp(sort: Desc)])
  @@map("portfolio")
}

// Ingestion Log - Data ingestion activity tracking
model IngestionLog {
  id            String    @id @default(uuid()) @db.Uuid
  ticker        String    @db.VarChar(10)
  timeframe     String    @db.VarChar(10)
  startDate     DateTime  @map("start_date") @db.Timestamptz(6)
  endDate       DateTime  @map("end_date") @db.Timestamptz(6)
  barsFetched   Int       @map("bars_fetched")
  barsInserted  Int       @map("bars_inserted")
  barsSkipped   Int       @map("bars_skipped")
  status        String    @db.VarChar(20)
  errorMessage  String?   @map("error_message") @db.Text
  durationMs    Int       @map("duration_ms")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([ticker, timeframe, createdAt(sort: Desc)])
  @@index([status])
  @@map("ingestion_log")
}

// FVG Detection - Fair Value Gap patterns (Fabio Valentini methodology)
model FvgDetection {
  id                String   @id @default(uuid()) @db.Uuid
  ticker            String   @db.VarChar(10)
  timeframe         String   @db.VarChar(10)
  detectedAt        DateTime @map("detected_at") @db.Timestamptz(6)

  // FVG Type and Direction
  fvgType           String   @map("fvg_type") @db.VarChar(20) // "bullish" or "bearish"
  tradingMode       String   @map("trading_mode") @db.VarChar(20) // "scalping", "intraday", "daily", etc.

  // 3-Candle Pattern Data
  candle1Timestamp  DateTime @map("candle1_timestamp") @db.Timestamptz(6)
  candle1High       Decimal  @map("candle1_high") @db.Decimal(12, 4)
  candle1Low        Decimal  @map("candle1_low") @db.Decimal(12, 4)

  candle2Timestamp  DateTime @map("candle2_timestamp") @db.Timestamptz(6)
  candle2High       Decimal  @map("candle2_high") @db.Decimal(12, 4)
  candle2Low        Decimal  @map("candle2_low") @db.Decimal(12, 4)

  candle3Timestamp  DateTime @map("candle3_timestamp") @db.Timestamptz(6)
  candle3High       Decimal  @map("candle3_high") @db.Decimal(12, 4)
  candle3Low        Decimal  @map("candle3_low") @db.Decimal(12, 4)

  // Gap Metrics
  gapHigh           Decimal  @map("gap_high") @db.Decimal(12, 4)
  gapLow            Decimal  @map("gap_low") @db.Decimal(12, 4)
  gapSize           Decimal  @map("gap_size") @db.Decimal(12, 4)
  gapSizePct        Decimal  @map("gap_size_pct") @db.Decimal(8, 4)

  // Entry and Exit Levels
  entryPrice        Decimal  @map("entry_price") @db.Decimal(12, 4)
  stopLoss          Decimal  @map("stop_loss") @db.Decimal(12, 4)
  takeProfit1       Decimal  @map("take_profit1") @db.Decimal(12, 4)
  takeProfit2       Decimal  @map("take_profit2") @db.Decimal(12, 4)
  takeProfit3       Decimal  @map("take_profit3") @db.Decimal(12, 4)

  // Fabio Valentini Validation Metrics
  volumeProfile     String?  @map("volume_profile") @db.VarChar(20) // "bell_curve", "skewed", etc.
  marketStructure   String?  @map("market_structure") @db.VarChar(50) // "balance_to_imbalance", "trending", etc.
  validationScore   Decimal? @map("validation_score") @db.Decimal(5, 4) // 0-1 confidence

  // Outcome Labels (for ML training)
  filled            Boolean? @default(false)
  filledAt          DateTime? @map("filled_at") @db.Timestamptz(6)
  hitTp1            Boolean? @map("hit_tp1") @default(false)
  hitTp1At          DateTime? @map("hit_tp1_at") @db.Timestamptz(6)
  hitTp2            Boolean? @map("hit_tp2") @default(false)
  hitTp2At          DateTime? @map("hit_tp2_at") @db.Timestamptz(6)
  hitTp3            Boolean? @map("hit_tp3") @default(false)
  hitTp3At          DateTime? @map("hit_tp3_at") @db.Timestamptz(6)
  hitStopLoss       Boolean? @map("hit_stop_loss") @default(false)
  hitStopLossAt     DateTime? @map("hit_stop_loss_at") @db.Timestamptz(6)
  holdTimeMins      Int?     @map("hold_time_mins")
  finalOutcome      String?  @map("final_outcome") @db.VarChar(20) // "tp1", "tp2", "tp3", "stop_loss", "pending"

  // ML Prediction (added later in Week 3+)
  predictedWinRate  Decimal? @map("predicted_win_rate") @db.Decimal(5, 4)
  predictedHoldTime Int?     @map("predicted_hold_time")
  modelName         String?  @map("model_name") @db.VarChar(50)

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([ticker, timeframe, detectedAt, fvgType])
  @@index([ticker, timeframe, detectedAt(sort: Desc)])
  @@index([tradingMode, detectedAt(sort: Desc)])
  @@index([fvgType, finalOutcome])
  @@index([detectedAt(sort: Desc)])
  @@map("fvg_detections")
}
